#!/usr/bin/make -f

#export DH_VERBOSE=1

DEB_UPSTREAM_VERSION=$(shell dpkg-parsechangelog \
	| sed -rne 's,^Version: ([^-]+).*,\1,p')

PYVERS=$(shell pyversions -vr)

clean:
	dh_testdir
	dh_testroot
	rm -f build-*
	rm -rf build
	find . -name '*\.py[co]' -delete
	dh_clean

build:

install: $(PYVERS:%=install-python%)
	dh_install
	mv $(CURDIR)/debian/python-mako/usr/share/vim/addons/indent/mako_indent.vim \
	   $(CURDIR)/debian/python-mako/usr/share/vim/addons/indent/mako.vim

install-python%:
	python$* setup.py install --prefix=/usr \
		--single-version-externally-managed \
		--root $(CURDIR)/debian/python-mako
	# use default Python version in shebang
	sed -i -e '1s,usr/bin/.*,usr/bin/python,' $(CURDIR)/debian/python-mako/usr/bin/mako-render
	# dpkg handles dependencies way better than Python
	find $(CURDIR)/debian/python-mako -name requires.txt -type f -delete

binary-indep: build install
	dh_testdir -i
	dh_testroot -i
	dh_installchangelogs -i CHANGES
	dh_installdocs -i
	dh_installexamples -i
	dh_installman -i
	rm -rf debian/python-mako/usr/share/doc/python-mako/doc/build
	# add jwilk's hack for one PKG-INFO file (until I will figure out why it changes)
	find debian/ -name PKG-INFO | tail -n +2 | xargs -r -n1 cp -vf $(shell find debian/ -name PKG-INFO | head -n 1)
	dh_pysupport -i
	dh_compress -i -X.py -Xmakotemplates.txt
	dh_fixperms -i
	dh_installdeb -i
	dh_gencontrol -i
	dh_md5sums -i
	dh_builddeb -i -- -Z bzip2

binary-arch:

binary: binary-indep binary-arch

.PHONY: build clean binary-indep binary-arch binary install configure
